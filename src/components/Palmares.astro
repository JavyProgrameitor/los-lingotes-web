---
import { palmares, type PalmaresEntry } from "../data/palmares";
import TrophyIcon from "../icons/TrophyIcon.astro";
import StarIcon from "../icons/StarIcon.astro";
import SparkleIcon from "../icons/SparkleIcon.astro";

const ordenarDesc = (a: PalmaresEntry, b: PalmaresEntry) => b.year - a.year;

const adultos = palmares.filter((p) => p.categoria === "Adultos").sort(ordenarDesc);
const infantil = palmares.filter((p) => p.categoria === "Infantil").sort(ordenarDesc);

const range = (n: number) => Array.from({ length: Math.max(0, n) }, (_, i) => i);

const cupsForPremio = (numero?: number) => {
  if (numero === 1) return 3;
  if (numero === 2) return 2;
  if (numero === 3) return 1;
  // 4º, 5º... sigue siendo premio: 1 copa
  return 1;
};

const badgeFor = (e: PalmaresEntry) => {
  if (e.tipo === "premio") return `Premio${e.numero ? ` · ${e.numero}º` : ""}`;
  if (e.tipo === "accesit") return `Accésit${e.numero ? ` · ${e.numero}º` : ""}`;
  return "Mención";
};

const accentBorderFor = (e: PalmaresEntry) =>
  e.tipo === "premio" || e.tipo === "especial"
    ? "border-amber-200/70 dark:border-amber-300/15"
    : "border-black/10 dark:border-white/10";

const glowFor = (e: PalmaresEntry) =>
  e.tipo === "premio" || e.tipo === "especial" ? "bg-amber-300/20" : "bg-white/10";

const statsFor = (items: PalmaresEntry[]) => {
  const registros = items.length;
  const titulos = items.filter((e) => e.tipo === "premio" && e.numero === 1).length;
  const podios = items.filter((e) => e.tipo === "premio" && (e.numero ?? 99) <= 3).length;
  const premios = items.filter((e) => e.tipo === "premio" || e.tipo === "especial").length;
  const accesits = items.filter((e) => e.tipo === "accesit").length;

  return { registros, titulos, podios, premios, accesits };
};

const statsAdultos = statsFor(adultos);
const statsInfantil = statsFor(infantil);

const totalTitulos = statsAdultos.titulos + statsInfantil.titulos;
const totalPremios = statsAdultos.premios + statsInfantil.premios;
const totalAccesits = statsAdultos.accesits + statsInfantil.accesits;
---

<section id="palmares" class="mx-auto w-full max-w-6xl px-4 py-14">
  <div class="mx-auto max-w-2xl text-center">
    <h2 class="text-balance text-3xl font-semibold tracking-tight text-neutral-900 dark:text-white">
      Palmarés
    </h2>
    <p class="mt-2 text-pretty text-sm text-neutral-600 dark:text-white/70">
      Premios y accésits de Los Lingotes en el Carnaval de Badajoz.
    </p>
  </div>

  <!-- Contadores -->
  <div class="mx-auto mt-7 grid max-w-4xl grid-cols-2 gap-3 sm:grid-cols-4">
    <div
      class="animate-fade-up rounded-xl border border-black/10 bg-white p-3 shadow-sm dark:border-white/10 dark:bg-white/5"
    >
      <div class="flex items-center gap-2">
        <div
          class="grid h-9 w-9 place-items-center rounded-lg bg-amber-500/10 text-amber-600 dark:text-amber-300"
        >
          <TrophyIcon class="h-5 w-5" />
        </div>
        <div>
          <div class="text-xs text-neutral-500 dark:text-white/60">Títulos Adultos (1º)</div>
          <div class="text-lg font-semibold tabular-nums text-neutral-900 dark:text-white">
            {statsAdultos.titulos}
          </div>
        </div>
      </div>
    </div>

    <div
      class="animate-fade-up [animation-delay:80ms] rounded-xl border border-black/10 bg-white p-3 shadow-sm dark:border-white/10 dark:bg-white/5"
    >
      <div class="flex items-center gap-2">
        <div
          class="grid h-9 w-9 place-items-center rounded-lg bg-amber-500/10 text-amber-600 dark:text-amber-300"
        >
          <TrophyIcon class="h-5 w-5" />
        </div>
        <div>
          <div class="text-xs text-neutral-500 dark:text-white/60">Títulos Infantil (1º)</div>
          <div class="text-lg font-semibold tabular-nums text-neutral-900 dark:text-white">
            {statsInfantil.titulos}
          </div>
        </div>
      </div>
    </div>

    <div
      class="animate-fade-up [animation-delay:160ms] rounded-xl border border-black/10 bg-white p-3 shadow-sm dark:border-white/10 dark:bg-white/5"
    >
      <div class="flex items-center gap-2">
        <div
          class="grid h-9 w-9 place-items-center rounded-lg bg-neutral-900/5 text-neutral-700 dark:bg-white/10 dark:text-white/70"
        >
          <TrophyIcon class="h-5 w-5" />
        </div>
        <div>
          <div class="text-xs text-neutral-500 dark:text-white/60">Premios (adultos+infantil)</div>
          <div class="text-lg font-semibold tabular-nums text-neutral-900 dark:text-white">
            {statsAdultos.premios + statsInfantil.premios}
          </div>
        </div>
      </div>
    </div>

    <div
      class="animate-fade-up [animation-delay:240ms] rounded-xl border border-black/10 bg-white p-3 shadow-sm dark:border-white/10 dark:bg-white/5"
    >
      <div class="flex items-center gap-2">
        <div
          class="grid h-9 w-9 place-items-center rounded-lg bg-amber-500/10 text-amber-600 dark:text-amber-300"
        >
          <StarIcon class="h-5 w-5" />
        </div>
        <div>
          <div class="text-xs text-neutral-500 dark:text-white/60">Accésits (adultos+infantil)</div>
          <div class="text-lg font-semibold tabular-nums text-neutral-900 dark:text-white">
            {statsAdultos.accesits + statsInfantil.accesits}
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="mt-10 grid gap-10 lg:grid-cols-2">
    <!-- Adultos -->
    <div>
      <div class="flex items-end justify-between gap-3">
        <h3 class="text-xl font-semibold text-neutral-900 dark:text-white">Adultos</h3>
        <span class="text-xs text-neutral-500 dark:text-white/60">{adultos.length} registros</span>
      </div>

      <div class="mt-4 grid grid-cols-2 gap-3 sm:grid-cols-3 lg:grid-cols-2 xl:grid-cols-3">
        {
          adultos.map((e, idx) => {
            const copaCount =
              e.tipo === "premio" ? cupsForPremio(e.numero) : e.tipo === "especial" ? 1 : 0;
            const starCount = e.tipo === "accesit" ? (e.numero ?? 0) : 0;
            const delay = Math.min(idx, 12) * 55;

            return (
              <article
                class:list={[
                  "group relative overflow-hidden rounded-lg border bg-white p-2.5 shadow-sm transition",
                  "dark:bg-white/5",
                  "animate-fade-up hover:-translate-y-0.5 hover:shadow-md",
                  `[animation-delay:${delay}ms]`,
                  accentBorderFor(e),
                ]}
              >
                <div
                  class:list={[
                    "pointer-events-none absolute -inset-10 opacity-0 blur-2xl transition group-hover:opacity-100",
                    glowFor(e),
                  ]}
                />

                <div
                  class:list={[
                    "pointer-events-none absolute inset-0 -translate-x-full bg-linear-to-r from-transparent via-white/25 to-transparent opacity-0",
                    "group-hover:opacity-100 group-hover:animate-shimmer",
                    e.tipo === "premio" || e.tipo === "especial" ? "" : "hidden",
                  ]}
                />

                <div class="relative">
                  <div class="flex items-start justify-between gap-2">
                    <div class="text-lg font-semibold tabular-nums text-neutral-900 dark:text-white">
                      {e.year}
                    </div>

                    <span class="shrink-0 rounded-full bg-neutral-100 px-2 py-0.5 text-[10px] font-medium text-neutral-700 dark:bg-white/10 dark:text-white/70">
                      {badgeFor(e)}
                    </span>
                  </div>

                  <div class="mt-2 flex flex-wrap items-center gap-1">
                    {copaCount > 0 && (
                      <div class="flex flex-wrap items-center gap-1 text-amber-600 dark:text-amber-300">
                        {range(copaCount).map((i) => (
                          <TrophyIcon class="h-4 w-4" aria-hidden="true" key={`c-${e.year}-${i}`} />
                        ))}
                      </div>
                    )}

                    {starCount > 0 && (
                      <div class="flex flex-wrap items-center gap-0.5 text-amber-600 dark:text-amber-300">
                        {range(starCount).map((i) => (
                          <StarIcon class="h-3 w-3" aria-hidden="true" key={`s-${e.year}-${i}`} />
                        ))}
                      </div>
                    )}

                    {copaCount === 0 && starCount === 0 && (
                      <div class="text-amber-600 dark:text-amber-300">
                        <SparkleIcon class="h-4 w-4" aria-hidden="true" />
                      </div>
                    )}
                  </div>

                  <div class="mt-2 text-sm font-medium text-neutral-900 dark:text-white">
                    {e.titulo}
                    {e.nota ? (
                      <span class="ml-1 text-neutral-500 dark:text-white/60">{e.nota}</span>
                    ) : null}
                  </div>

                  {e.fuente && (
                    <div class="mt-1 text-[11px] text-neutral-500 dark:text-white/60">
                      {e.fuente}
                    </div>
                  )}
                </div>
              </article>
            );
          })
        }
      </div>
    </div>

    <!-- Infantil -->
    <div>
      <div class="flex items-end justify-between gap-3">
        <h3 class="text-xl font-semibold text-neutral-900 dark:text-white">Infantil</h3>
        <span class="text-xs text-neutral-500 dark:text-white/60">{infantil.length} registros</span>
      </div>

      <div class="mt-4 grid grid-cols-2 gap-3 sm:grid-cols-3 lg:grid-cols-2 xl:grid-cols-3">
        {
          infantil.map((e, idx) => {
            const copaCount =
              e.tipo === "premio" ? cupsForPremio(e.numero) : e.tipo === "especial" ? 1 : 0;
            const starCount = e.tipo === "accesit" ? (e.numero ?? 0) : 0;
            const delay = Math.min(idx, 12) * 55;

            return (
              <article
                class:list={[
                  "group relative overflow-hidden rounded-lg border bg-white p-2.5 shadow-sm transition",
                  "dark:bg-white/5",
                  "animate-fade-up hover:-translate-y-0.5 hover:shadow-md",
                  `[animation-delay:${delay}ms]`,
                  accentBorderFor(e),
                ]}
              >
                <div
                  class:list={[
                    "pointer-events-none absolute -inset-10 opacity-0 blur-2xl transition group-hover:opacity-100",
                    glowFor(e),
                  ]}
                />

                <div
                  class:list={[
                    "pointer-events-none absolute inset-0 -translate-x-full bg-linear-to-r from-transparent via-white/25 to-transparent opacity-0",
                    "group-hover:opacity-100 group-hover:animate-shimmer",
                    e.tipo === "premio" || e.tipo === "especial" ? "" : "hidden",
                  ]}
                />

                <div class="relative">
                  <div class="flex items-start justify-between gap-2">
                    <div class="text-lg font-semibold tabular-nums text-neutral-900 dark:text-white">
                      {e.year}
                    </div>

                    <span class="shrink-0 rounded-full bg-neutral-100 px-2 py-0.5 text-[10px] font-medium text-neutral-700 dark:bg-white/10 dark:text-white/70">
                      {badgeFor(e)}
                    </span>
                  </div>

                  <div class="mt-2 flex flex-wrap items-center gap-1">
                    {copaCount > 0 && (
                      <div class="flex flex-wrap items-center gap-1 text-amber-600 dark:text-amber-300">
                        {range(copaCount).map((i) => (
                          <TrophyIcon class="h-4 w-4" aria-hidden="true" key={`c-${e.year}-${i}`} />
                        ))}
                      </div>
                    )}

                    {starCount > 0 && (
                      <div class="flex flex-wrap items-center gap-0.5 text-amber-600 dark:text-amber-300">
                        {range(starCount).map((i) => (
                          <StarIcon class="h-3 w-3" aria-hidden="true" key={`s-${e.year}-${i}`} />
                        ))}
                      </div>
                    )}

                    {copaCount === 0 && starCount === 0 && (
                      <div class="text-amber-600 dark:text-amber-300">
                        <SparkleIcon class="h-4 w-4" aria-hidden="true" />
                      </div>
                    )}
                  </div>

                  <div class="mt-2 text-sm font-medium text-neutral-900 dark:text-white">
                    {e.titulo}
                    {e.nota ? (
                      <span class="ml-1 text-neutral-500 dark:text-white/60">{e.nota}</span>
                    ) : null}
                  </div>

                  {e.fuente && (
                    <div class="mt-1 text-[11px] text-neutral-500 dark:text-white/60">
                      {e.fuente}
                    </div>
                  )}
                </div>
              </article>
            );
          })
        }
      </div>
    </div>
  </div>
</section>
