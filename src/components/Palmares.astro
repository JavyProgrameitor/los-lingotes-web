---
import { palmares, type PalmaresEntry } from "../data/palmares";
import TrophyIcon from "../icons/TrophyIcon.astro";
import StarIcon from "../icons/StarIcon.astro";
import SparkleIcon from "../icons/SparkleIcon.astro";

const ordenarDesc = (a: PalmaresEntry, b: PalmaresEntry) => b.year - a.year;

const adultos = palmares.filter((p) => p.categoria === "Adultos").sort(ordenarDesc);
const infantil = palmares.filter((p) => p.categoria === "Infantil").sort(ordenarDesc);

const range = (n: number) => Array.from({ length: Math.max(0, n) }, (_, i) => i);

const cupsForPremio = (numero?: number) => {
  if (numero === 1) return 3;
  if (numero === 2) return 2;
  if (numero === 3) return 1;
  return 1;
};

const badgeFor = (e: PalmaresEntry) => {
  if (e.tipo === "premio") return `Premio${e.numero ? ` · ${e.numero}º` : ""}`;
  if (e.tipo === "accesit") return `Accésit${e.numero ? ` · ${e.numero}º` : ""}`;
  return "Mención";
};

const accentBorderFor = (e: PalmaresEntry) =>
  e.tipo === "premio" || e.tipo === "especial"
    ? "border-amber-200/70 dark:border-amber-300/20"
    : "border-black/10 dark:border-white/10";

const glowFor = (e: PalmaresEntry) =>
  e.tipo === "premio" || e.tipo === "especial" ? "bg-amber-300/20" : "bg-white/10";

const statsFor = (items: PalmaresEntry[]) => ({
  registros: items.length,
  titulos: items.filter((e) => e.tipo === "premio" && e.numero === 1).length,
  podios: items.filter((e) => e.tipo === "premio" && (e.numero ?? 99) <= 3).length,
  premios: items.filter((e) => e.tipo === "premio" || e.tipo === "especial").length,
  accesits: items.filter((e) => e.tipo === "accesit").length,
});

const statsAdultos = statsFor(adultos);
const statsInfantil = statsFor(infantil);
---

<section id="palmares" class="mx-auto w-full max-w-6xl px-4 py-14">
  <!-- Cabecera -->
  <div class="mx-auto max-w-2xl text-center">
    <h2 class="text-3xl font-semibold tracking-tight text-neutral-900 dark:text-white">Palmarés</h2>
    <p class="mt-2 text-sm text-neutral-600 dark:text-white/70">
      Premios y accésits de Los Lingotes en el Carnaval de Badajoz.
    </p>
  </div>

  <!-- Contadores -->
  <div class="mx-auto mt-7 grid max-w-4xl grid-cols-2 gap-3 sm:grid-cols-4">
    <div
      class="animate-fade-up rounded-xl border border-black/10 bg-white p-3 shadow-sm dark:border-white/10 dark:bg-white/5"
    >
      <div class="flex items-center gap-2">
        <div
          class="grid h-9 w-9 place-items-center rounded-lg bg-amber-500/10 text-amber-600 dark:text-amber-300"
        >
          <TrophyIcon class="h-5 w-5" />
        </div>
        <div>
          <div class="text-xs text-neutral-500 dark:text-white/60">
            Títulos Adultos (Primer Premio)
          </div>
          <div class="text-lg font-semibold text-neutral-900 dark:text-white">
            {statsAdultos.titulos}
          </div>
        </div>
      </div>
    </div>

    <div
      class="animate-fade-up [animation-delay:80ms] rounded-xl border border-black/10 bg-white p-3 shadow-sm dark:border-white/10 dark:bg-white/5"
    >
      <div class="flex items-center gap-2">
        <div
          class="grid h-9 w-9 place-items-center rounded-lg bg-amber-500/10 text-amber-600 dark:text-amber-300"
        >
          <TrophyIcon class="h-5 w-5" />
        </div>
        <div>
          <div class="text-xs text-neutral-500 dark:text-white/60">
            Títulos Infantil (Primer Premio)
          </div>
          <div class="text-lg font-semibold text-neutral-900 dark:text-white">
            {statsInfantil.titulos}
          </div>
        </div>
      </div>
    </div>

    <div
      class="animate-fade-up [animation-delay:160ms] rounded-xl border border-black/10 bg-white p-3 shadow-sm dark:border-white/10 dark:bg-white/5"
    >
      <div class="flex items-center gap-2">
        <div
          class="grid h-9 w-9 place-items-center rounded-lg bg-neutral-900/5 text-neutral-700 dark:bg-white/10 dark:text-white/70"
        >
          <TrophyIcon class="h-5 w-5" />
        </div>
        <div>
          <div class="text-xs text-neutral-500 dark:text-white/60">Premios totales</div>
          <div class="text-lg font-semibold text-neutral-900 dark:text-white">
            {statsAdultos.premios + statsInfantil.premios}
          </div>
        </div>
      </div>
    </div>

    <div
      class="animate-fade-up [animation-delay:240ms] rounded-xl border border-black/10 bg-white p-3 shadow-sm dark:border-white/10 dark:bg-white/5"
    >
      <div class="flex items-center gap-2">
        <div
          class="grid h-9 w-9 place-items-center rounded-lg bg-amber-500/10 text-amber-600 dark:text-amber-300"
        >
          <StarIcon class="h-5 w-5" />
        </div>
        <div>
          <div class="text-xs text-neutral-500 dark:text-white/60">Accésits totales</div>
          <div class="text-lg font-semibold text-neutral-900 dark:text-white">
            {statsAdultos.accesits + statsInfantil.accesits}
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Listados -->
  <div class="mt-10 grid gap-10 lg:grid-cols-2">
    {
      [
        { title: "Adultos", items: adultos },
        { title: "Infantil", items: infantil },
      ].map(({ title, items }) => (
        <div>
          <div class="flex items-end justify-between gap-3">
            <h3 class="text-xl font-semibold text-neutral-900 dark:text-white">{title}</h3>
            <span class="text-xs text-neutral-500 dark:text-white/60">
              {items.length} registros
            </span>
          </div>

          <div class="mt-4 grid grid-cols-2 gap-3 sm:grid-cols-3 lg:grid-cols-2 xl:grid-cols-3">
            {items.map((e, idx) => {
              const copaCount =
                e.tipo === "premio" ? cupsForPremio(e.numero) : e.tipo === "especial" ? 1 : 0;
              const starCount = e.tipo === "accesit" ? (e.numero ?? 0) : 0;
              const delay = Math.min(idx, 12) * 55;

              return (
                <details
                  class:list={[
                    "group relative overflow-hidden rounded-lg border bg-white p-2.5 shadow-sm transition",
                    "dark:bg-white/5",
                    // PC hover + móvil touch feedback
                    "animate-fade-up hover:-translate-y-0.5 hover:shadow-md",
                    "active:scale-[0.99] active:shadow-md",
                    // Accesible por teclado
                    "focus-within:-translate-y-0.5 focus-within:shadow-md focus-within:outline-none focus-within:ring-2 focus-within:ring-amber-400/40",
                    `[animation-delay:${delay}ms]`,
                    accentBorderFor(e),
                  ]}
                >
                  <div
                    class:list={[
                      "pointer-events-none absolute -inset-10 opacity-0 blur-2xl transition",
                      "group-hover:opacity-100 group-active:opacity-100 group-focus-within:opacity-100 group-open:opacity-100",
                      glowFor(e),
                    ]}
                  />
                  <div
                    class:list={[
                      "pointer-events-none absolute inset-0 -translate-x-full bg-linear-to-r from-transparent via-white/25 to-transparent opacity-0",
                      "group-hover:opacity-100 group-hover:animate-shimmer",
                      "group-active:opacity-100 group-active:animate-shimmer",
                      "group-focus-within:opacity-100 group-focus-within:animate-shimmer",
                      "group-open:opacity-100 group-open:animate-shimmer",
                      e.tipo === "premio" || e.tipo === "especial" ? "" : "hidden",
                    ]}
                  />
                  <summary class="relative list-none cursor-pointer select-none [&::-webkit-details-marker]:hidden">
                    {/* caret solo en móvil */}
                    <span class="pointer-events-none absolute right-2 top-2 text-neutral-400 transition group-open:rotate-180 dark:text-white/50 sm:hidden">
                      ▾
                    </span>

                    <div class="relative">
                      <div class="flex items-start justify-between gap-2 pr-6 sm:pr-0">
                        <div class="text-lg font-semibold tabular-nums text-neutral-900 dark:text-white">
                          {e.year}
                        </div>
                        <span class="shrink-0 rounded-full bg-neutral-100 px-2 py-0.5 text-[10px] font-medium text-neutral-700 dark:bg-white/10 dark:text-white/70">
                          {badgeFor(e)}
                        </span>
                      </div>

                      <div class="mt-2 flex flex-wrap items-center gap-1 text-amber-600 dark:text-amber-300">
                        {copaCount > 0 &&
                          range(copaCount).map((i) => (
                            <TrophyIcon
                              key={`c-${e.year}-${i}`}
                              class="h-4 w-4"
                              aria-hidden="true"
                            />
                          ))}

                        {starCount > 0 &&
                          range(starCount).map((i) => (
                            <StarIcon key={`s-${e.year}-${i}`} class="h-3 w-3" aria-hidden="true" />
                          ))}

                        {copaCount === 0 && starCount === 0 && (
                          <SparkleIcon class="h-4 w-4" aria-hidden="true" />
                        )}
                      </div>

                      <div class="mt-2 text-sm font-medium text-neutral-900 dark:text-white">
                        {e.titulo}
                        {e.nota && (
                          <span class="ml-1 text-neutral-500 dark:text-white/60">{e.nota}</span>
                        )}
                      </div>

                      {/* En PC mantenemos “Fuente” visible como antes */}
                      {e.fuente && (
                        <div class="mt-1 hidden text-[11px] text-neutral-500 dark:text-white/60 sm:block">
                          {e.fuente}
                        </div>
                      )}

                      {/* Hint táctil en móvil */}
                      <div class="mt-1 text-[11px] text-neutral-500 dark:text-white/60 sm:hidden">
                        Toca para ver detalles
                      </div>
                    </div>
                  </summary>

                  {/* Panel desplegable SOLO móvil */}
                  <div
                    class:list={[
                      "relative mt-2 overflow-hidden rounded-md border border-black/5 bg-neutral-50 px-2.5 py-2 text-[12px] text-neutral-700",
                      "dark:border-white/10 dark:bg-white/5 dark:text-white/70",
                      "sm:hidden",
                      // Animación open/close sin CSS extra
                      "max-h-0 opacity-0 transition-all duration-300 ease-out",
                      "group-open:max-h-40 group-open:opacity-100",
                    ]}
                  >
                    {e.nota || e.fuente ? (
                      <div class="space-y-1">
                        {e.nota && (
                          <div>
                            <span class="font-medium text-neutral-900 dark:text-white">Nota:</span>{" "}
                            <span>{e.nota}</span>
                          </div>
                        )}
                        {e.fuente && (
                          <div>
                            <span class="font-medium text-neutral-900 dark:text-white">
                              Fuente:
                            </span>{" "}
                            <span>{e.fuente}</span>
                          </div>
                        )}
                        <div class="pt-1 text-[11px] text-neutral-500 dark:text-white/50">
                          Toca de nuevo para cerrar
                        </div>
                      </div>
                    ) : (
                      <div class="text-neutral-500 dark:text-white/50">Sin detalles extra.</div>
                    )}
                  </div>
                </details>
              );
            })}
          </div>
        </div>
      ))
    }
  </div>
</section>
